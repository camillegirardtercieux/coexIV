---
title: "Analysis of tropical forest inventory data"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    number_sections: true
  bookdown::pdf_book:
    toc: true
    toc_float: true
    number_sections: true
bibliography: "`r here::here('tools_latex', 'References.bib')`"
csl: "`r here::here('tools_latex', 'bib_style.csl')`"
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \usepackage{float}
  - \floatplacement{figure}{H}
  - \renewcommand{\thefigure}{S\thesection.\arabic{figure}}
  - \renewcommand{\thetable}{S\thesection.\arabic{table}}
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, fig.pos='H')
```


In this section, we aimed at exploring the intraspecific variability of tree growth in three hyperdiverse mature forests, encompassing contrasting climates and disturbance regimes across the Tropics. First, for each dataset, we estimated the intraspecific variance of annualized growth using a hierarchical bayesian model. Then, we tested if spatial structure in individual mean growth could be detected. Finally, we tested if intraspecific variability was higher than interspecific variability in individual mean growth.

Note that we here used data on tree growth, which is one component of individual fitness and an imperfect proxy of tree competitive ability, and our analyses could be further tested with other traits in the future. 


# Datasets

## Paracou

```{r ChargeParacou, message=FALSE, warning=FALSE}
Paracou <- coexIV::read_data_paracou()
```

```{r RenameSpeciesParacou, eval=FALSE, include=FALSE}
Paracou <- coexIV::rename_indet_paracou(Paracou) %>% coexIV::create_identspecies()
```

The Paracou forest is located in French Guiana. It is one of the best-studied lowland tropical forests in the Guiana Shield region. It belongs to the Caesalpiniaceae facies and has amongst the highest alpha-diversity in the Guiana shield with 150-200 tree species per hectare in inventories of trees with diameter at breast height (DBH) $\ge$ 10 cm. The Guiana Shield is characterized by Pre-Cambrian granitic and metamorphic geological formations, highly eroded. It is associated with gently undulating landscapes and a very dense hydrographic system. Paracou forest lies in a hilly area, on a formation called “série Armina” characterized by schists and sandstones and locally crossed by veins of pegmatite, aplite and quartz. The topography of the site consists of small hills separated by narrow (< 5 m wide) sandy waterbeds. The altitude varies from 5 to about 45 m above sea level [@gourlet-fleury_ecology_2004, @herault_key_2018]. The mean annual temperature is 26 °C and winds are generally weak. There is a well marked dry season (from mid-August to mid-November) and a long rain season with a short drier period between March and April (mean annual rainfall of 3,041 mm). Different study programs have been led at the Paracou site (https://paracou.cirad.fr/).
Here, we used data from a disturbance experiment, where 12 square plots of 6.25 ha were exposed to four different logging intensities between 1986 and 1988, as well as four square plots of 6.25 ha which were set up for biodiversity monitoring in 1990-1992 (plots 1-15). Since then, cartesian coordinates, DBH, species identity and survival of each tree with a DBH $\ge$ 10 cm have been collected every one or two years, during the dry season (mid-August to mid-November).
The studied 93.75-ha area harbours `r length(unique(Paracou$idTree))` measured trees, among which `r length(unique(Paracou[which(Paracou$Sp=="Indet_sp"),]$idTree))` belong to an undetermined species and others belong to `r length(unique(Paracou$Sp))-1` determined species, `r length(unique(Paracou$Genus))-1` genera and `r length(unique(Paracou$Family))` families.

```{r RemoveYearsParacou}
Paracou <- Paracou[which(!(Paracou$CensusYear %in% c(1985:1991))),]
```

We removed all measures of the years before the perturbations were performed and the biodiversity plots were added (1985-1991), thus obtaining a dataset containing `r length(unique(Paracou$idTree))` measured trees, among which `r length(unique(Paracou[which(Paracou$Sp=="Indet_sp"),]$idTree))` belong to an undetermined species and others belong to `r length(unique(Paracou$Sp))-1` determined species, `r length(unique(Paracou$Genus))-1` genera and `r length(unique(Paracou$Family))` families.

```{r ProducePlotParacou}
g <- ggplot2::ggplot(data=Paracou, ggplot2::aes(x=Xutm, y=Yutm))+ggplot2::geom_point(size=0.1)+ggplot2::labs(x="X (UTM)", y = "Y (UTM")+ggplot2::coord_fixed(ratio = 1)
ggplot2::ggsave(filename = "Paracou_site.png", path=here::here("outputs", "tropical_analysis", "figures"), device = "png", width = 7, height = 5, dpi = 300)

```

Figure \@ref(fig:IncludePlotParacou) shows the location of the used trees in the Paracou site.

```{r IncludePlotParacou, echo=FALSE, fig.cap = "Plots at the Paracou site. Each point is a tree."}
knitr::include_graphics(here::here("outputs", "tropical_analysis", "figures", "Paracou_site.png"))
```

## Uppangala

```{r ChargeUppangala}
load(here::here("data", "Uppangala", "upsp.dataset.Rdata"))
```

```{r NamesUppangala, eval=FALSE, include=FALSE}
Species_list_Uppangala <- read.table(here::here("data", "Uppangala", "Species_list_Uppangala.txt"), sep = "\t", header = TRUE)

Species_list_Uppangala$Genus <- stringr::str_split_fixed(Species_list_Uppangala$LatinName, " ", 2)[,1]

upsp.dataset$Sp <- Species_list_Uppangala$LatinName[match(upsp.dataset$SpCode, Species_list_Uppangala$SpCode)]

upsp.dataset$Genus <- Species_list_Uppangala$Genus[match(upsp.dataset$SpCode, Species_list_Uppangala$SpCode)]

upsp.dataset$Family <- Species_list_Uppangala$Family[match(upsp.dataset$SpCode, Species_list_Uppangala$SpCode)]
```

The Uppangala Permanent Sample Plot (UPSP) is located in South-East Asia, in the Western Ghats of India, and was established in 1989 by the French Institute of Pondicherry in the Kadamakal Reserve Forest, in the Pushpagiri Wildlife Sanctuary, in Karnataka state, India [@pelissier_tree_2011]. It is a low altitude (500-600 m) wet evergreen monsoon Dipterocarp forest [@bec_characterizing_2015]. This forest is considered as one of the rare undisturbed tropical forests in the world [@pascal_structure_1996].
The studied area of 5.07 ha is quite steep, with a mean slope angle of about 30–35°. The plots consist in five North–South oriented transects that are 20-m wide, 180- to 370-m long, and 100-m apart center to center, in addition to three rectangular plots which overlap the transects. The transects gather data from 1990 to 2011 and the rectangular plots from 1993 to 2011. The trees with GBH (Girth at Breast Height) $\ge$ 30 cm (equivalent to ca. 9.5 cm DBH) were measured every 3 to 5 years. The original dataset contains measurements of `r length(unique(upsp.dataset$TreeID))` trees of `r length(unique(upsp.dataset$SpCode))` species (including 2 morphospecies),`r length(unique(upsp.dataset$Genus))` genera and `r length(unique(upsp.dataset$Family))` families.

We removed the census dates which were not common for all plots (1990-1992).

```{r RemoveYearsUppangala, eval=FALSE, include=FALSE}
upsp.dataset <- upsp.dataset[which(upsp.dataset$date>1339),]
```

Thus, we obtained a dataset containing `r length(unique(upsp.dataset$TreeID))` trees of `r length(unique(upsp.dataset$SpCode))` species (including 2 morphospecies),`r length(unique(upsp.dataset$Genus))` genera and `r length(unique(upsp.dataset$Family))` families.

```{r ProducePlotUppangala}
g <- ggplot2::ggplot(data=upsp.dataset, ggplot2::aes(x=Xsite, y=Ysite))+ggplot2::geom_point(size=0.5)+ggplot2::labs(x="X (m)", y = "Y (m)")
#Save as png and include in order to make the pdf lighter
ggplot2::ggsave(filename = "Uppangala_site.png", path=here::here("outputs", "tropical_analysis", "figures"), device = "png", width = 7, height = 5, dpi=300)

```

Figure \@ref(fig:IncludePlotUppangala) shows the location of the trees in the Uppangala site.

```{r IncludePlotUppangala, echo=FALSE, fig.cap="Plots at Uppangala site. Each point is a tree."}
knitr::include_graphics(here::here("outputs", "tropical_analysis", "figures", "Uppangala_site.png"))
```

## BCI

```{r ChargeBCI, include=FALSE}
BCI <- coexIV::read_data_bci()
load(here::here("data", "BCI", "bci.spptable.rdata"))
BCI$Sp <- bci.spptable$Latin[match(BCI$sp, bci.spptable$sp)]
BCI$Genus <- bci.spptable$Genus[match(BCI$sp, bci.spptable$sp)]
BCI$Family <- bci.spptable$Family[match(BCI$sp, bci.spptable$sp)]
```

The Barro Colorado Island site is located in central America, in Panama, covered by a lowland tropical moist forest. The zone became an island after a valley was flooded in order to build the Panama Canal, in 1913. It is nowadays considered as the most intensively studied tropical forest in the world. The studied site is a 50 ha plot (500 $\times$ 1,000 m). It has an elevation of 120 m and is quite flat (most slopes are gentler than 10°). Complete censuses of all trees with DBH $\ge$ 1 cm have been performed every 5 years since 1980. The dataset contains measurements of `r length(unique(BCI$treeID))` trees of `r length(unique(BCI$sp))` tree species, `r length(unique(BCI$Genus))` genera and `r length(unique(BCI$Family))` families.

```{r RemoveValuesBCI, include=FALSE}
BCI <- BCI[is.na(BCI$dbh)==F,]#remove NA
BCI <- BCI[which(BCI$dbh>=100),]#remove trees with DBH < 10cm (for consistance with the other datasets)
```

When only taking into account trees with DBH $\ge$ 10 cm for consistency with the other datasets, it contains measurements of `r length(unique(BCI$treeID))` trees of `r length(unique(BCI$sp))` tree species, `r length(unique(BCI$Genus))` genera and `r length(unique(BCI$Family))` families.
The dataset is available in [@condit_complete_2019].

```{r ProducePlotBCI, warning=FALSE}
g <- ggplot2::ggplot(data=BCI, ggplot2::aes(x=gx, y=gy))+ggplot2::geom_point(size=0.5, alpha = 0.2)+ggplot2::labs(x="X (m)", y="Y (m)")
ggplot2::ggsave(filename = "BCI_site.png", path=here::here("outputs", "tropical_analysis", "figures"), device = "png", width = 7, height = 5, dpi=300)
```

Figure \@ref(fig:IncludePlotBCI) shows the location of the selected trees in the BCI site.

```{r IncludePlotBCI, echo=FALSE, fig.cap="The 50 ha plot of the Barro Colorado Island site. Each point is a tree.", warning=FALSE}
knitr::include_graphics(here::here("outputs", "tropical_analysis", "figures", "BCI_site.png"))
```


# Growth and mean growth estimation

For all three datasets, we computed annualized growth between two censuses as the difference of DBH between two consecutive censuses, divided by the time period between those two censuses. We then removed estimates with a growth < -2 mm/year or > 100 mm/year.

```{r GrowthParacou, eval=FALSE, include=FALSE}
Paracou_no_mean <- coexIV::compute_growth_paracou(Paracou)
rm(Paracou)
```

```{r LoadParacouNoMean1, include=FALSE}
load(here::here("outputs", "tropical_analysis", "Paracou_no_mean.RData"))
```

```{r RemoveValuesParacou, eval=FALSE, include=FALSE}
Paracou_no_mean <- Paracou_no_mean[Paracou_no_mean$G_tp1_corr>(-2)&Paracou_no_mean$G_tp1_corr<100,]

Paracou_no_mean <- Paracou_no_mean%>%
  dplyr::mutate(Growth = G_tp1_corr, Diameter = D_t_corr)
save(Paracou_no_mean, file = here::here("outputs", "tropical_analysis", "Paracou_no_mean.RData"))
```

```{r LoadParacouNoMean, include=FALSE}
load(here::here("outputs", "tropical_analysis", "Paracou_no_mean.RData"))
```

```{r MeanGrowthParacou, message=FALSE, warning=FALSE, paged.print=TRUE}
Data_Paracou <- coexIV::compute_mean_growth_paracou(Paracou_no_mean)
Data_Paracou <- Data_Paracou%>%
  dplyr::mutate(Growth = G_tp1_corr, Diameter = D_t_corr, X = Xutm, Y = Yutm)

save(Data_Paracou, file = here::here("outputs", "tropical_analysis", "Data_Paracou.RData"))
```

```{r LoadDataParacou, include=FALSE}
load(here::here("outputs", "tropical_analysis", "Data_Paracou.RData"))
```


```{r GrowthUppangala, eval=FALSE, include=FALSE}
Uppangala_no_mean <- coexIV::compute_growth_uppangala(upsp.dataset)
```

```{r RemoveValuesUppangala, eval=FALSE, include=FALSE}
Uppangala_no_mean <- Uppangala_no_mean[Uppangala_no_mean$G_tp1>(-2)&Uppangala_no_mean$G_tp1<100,]
Uppangala_no_mean <- Uppangala_no_mean %>%
  dplyr::mutate(idTree = TreeID, Tree = TreeID, Growth = G_tp1, Diameter = D_t, Plot_name = Plot)
levels(Uppangala_no_mean$Plot) <- 1:length(levels(Uppangala_no_mean$Plot))
Uppangala_no_mean$Plot <- as.numeric(Uppangala_no_mean$Plot)
save(Uppangala_no_mean, file = here::here("outputs", "tropical_analysis", "Uppangala_no_mean.RData"))
```

```{r LoadUppangalaNoMean, include=FALSE}
load(here::here("outputs", "tropical_analysis", "Uppangala_no_mean.RData"))
```

```{r MeanGrowthUppangala, eval=FALSE, include=FALSE}
Data_Uppangala <- coexIV::compute_mean_growth_uppangala(Uppangala_no_mean)
Data_Uppangala <- Data_Uppangala%>%
  dplyr::mutate(idTree = TreeID, Tree = TreeID, Growth = G_tp1, Diameter = D_t, X = Xsite, Y = Ysite, Plot_name = Plot)
levels(Data_Uppangala$Plot) <- 1:length(levels(Data_Uppangala$Plot))
Data_Uppangala$Plot <- as.numeric(Data_Uppangala$Plot)

save(Data_Uppangala, file = here::here("outputs", "tropical_analysis", "Data_Uppangala.RData"))
```

```{r LoadDataUppangala}
load(here::here("outputs", "tropical_analysis", "Data_Uppangala.RData"))
```


```{r GrowthBCI, eval=FALSE, include=FALSE}
BCI_no_mean <- compute_growth_BCI(BCI)
rm(BCI)
gc()
```

```{r RemoveValuesBCI2, eval=FALSE, include=FALSE}
BCI_no_mean <- BCI_no_mean[BCI_no_mean$G_tp1>(-2)&BCI_no_mean$G_tp1<100,]
BCI_no_mean <- BCI_no_mean %>%
  dplyr::mutate(idTree=treeID, Tree = treeID, Growth=G_tp1, Diameter=D_t)
BCI_no_mean$Plot <- 1
save(BCI_no_mean, file = here::here("outputs", "tropical_analysis", "BCI_no_mean.RData"))
```

```{r LoadBCInomean, include=FALSE}
load(here::here("outputs", "tropical_analysis", "BCI_no_mean.RData"))
```

```{r MeanGrowthBCI, eval=FALSE, include=FALSE}
Data_BCI <- compute_mean_growth_BCI(BCI_no_mean)
Data_BCI <- Data_BCI%>%
  dplyr::mutate(idTree = treeID, Tree = treeID, Growth = G_tp1, Diameter = D_t, X = gx, Y = gy)
Data_BCI$Plot <- 1
save(Data_BCI, file = here::here("outputs", "tropical_analysis", "Data_BCI.RData"))
```

```{r LoadBCImean, include=FALSE}
load(here::here("outputs", "tropical_analysis", "Data_BCI.RData"))
```

For the Paracou site, after removing `r nrow(Paracou_no_mean[which(Paracou_no_mean$Sp=="Indet_sp"),])` growth estimates for `r length(unique(Paracou_no_mean[which(Paracou_no_mean$Sp=="Indet_sp"),]$idTree))` trees of indeterminate species, we obtained a dataset with `r nrow(Paracou_no_mean[which(Paracou_no_mean$Sp!="Indet_sp"),])` growth estimates for `r length(unique(Paracou_no_mean[which(Paracou_no_mean$Sp!="Indet_sp"),]$idTree))` trees of `r length(unique(Paracou_no_mean[which(Paracou_no_mean$Sp!="Indet_sp"),]$Sp))` species.

For the Uppangala site, we obtained a dataset with `r nrow(Uppangala_no_mean)` growth estimates for `r length(unique(Uppangala_no_mean$TreeID))` trees of `r length(unique(Uppangala_no_mean$SpCode))` species.

For the BCI site, we obtained a dataset with `r nrow(BCI_no_mean)` growth estimates for `r length(unique(BCI_no_mean$treeID))` trees of `r length(unique(BCI_no_mean$sp))` species.

For all three datasets, we finally computed the mean annual growth for each individual tree as the difference of DBH between the first and the last time a tree was measured, divided by the period between those two measurements.

```{r AbundanceDiagrams, out.width = "50%", fig.show="hold", fig.cap="Abundance diagrams for the three study sites. For the Paracou site, only individuals that were identified to the species level are accounted for. The three communities include few dominant species and many rare species (long asymptote)."}

coexIV::abundance_diagram(Data_Paracou, site = "Paracou")
coexIV::abundance_diagram(Data_Uppangala, site = "Uppangala")
coexIV::abundance_diagram(Data_BCI, site = "BCI")

knitr::include_graphics(
  c(
    here::here("outputs", "tropical_analysis", "figures", "Paracou_abundance_determined.png"),
    here::here("outputs", "tropical_analysis", "figures", "Uppangala_abundance.png"),
    here::here("outputs", "tropical_analysis", "figures", "BCI_abundance.png")
    )
  )

```


# Estimation of IV

To quantify the relative importance of intraspecific and interspecific variability for each site, we used Stan to run a Bayesian hierarchical model, with a species random effect and an individual random effect on the intercept. In order to compare to classic growth models, and estimate an intraspecific variability within diameter classes, we also added an intercept and a diameter fixed effect. We used the brms package [@burkner_brms_2017 ; @burkner_advanced_2018] to implement the model. We scaled the data to improve convergence time.


$ln(G_{ijt} + 2) = [\beta_0 + b_{0j} + d_{0i}] + \beta_1 \times ln(D_{ijt}) + \epsilon_{ijt},$ 

Priors

$\beta_0 \sim \mathcal{N}(mean=0, var = 1), iid$

$\beta_1 \sim \mathcal{N}(mean=0, var = 1), iid$

$b_{0j} \sim \mathcal{N}(mean=0, var=V_b), iid$

$d_{0j} \sim \mathcal{N}(mean=0, var=V_d), iid$

$\epsilon_{ijt} \sim  \mathcal{N}(mean=0, var=V), iid$

Hyperpriors

$V_b \sim \mathcal{IG}(shape = 10^{-3}, rate = 10^{-3}), iid$

$V_d \sim \mathcal{IG}(shape = 10^{-3}, rate = 10^{-3}), iid$

$V \sim \mathcal{IG}(shape = 10^{-3}, rate = 10^{-3}), iid$

Where $i$ is the individual and $j$ the species.
The model included two fixed effects ($\beta_0$ and $\beta_1$), a random species effect $b_{0j}$ on the intercept and a random individual effect $d_{0i}$ on the intercept. $V_d$ is the intraspecific variance and $V_b$ is the interspecific variance.

## Paracou

```{r ModelParacou, eval=FALSE, include=FALSE}
Data_stan_Paracou <- Paracou_no_mean[which((as.character(Paracou_no_mean$Sp))!="Indet_sp"),]
Data_stan_Paracou <-  coexIV::create_identspecies(Data_stan_Paracou)

Data_stan_Paracou <- coexIV::prep_stan(Data_stan_Paracou)

Sample <- 100000

Data_stan_Paracou <- Data_stan_Paracou[sample(1:nrow(Data_stan_Paracou),Sample),]

print(nrow(Data_stan_Paracou))

options("m.cores"=2)

### Priors

prior_brms <- c(brms::prior(normal(0, 1), class = "Intercept"),
                brms::prior(normal(0, 1), class = "b"),
                brms::prior(inv_gamma(10^-3, 10^-3), class = "sd"))

### Fit

brms_mod <- brms::brm(formula = logG ~ 1 + logD + (1|IdentSpecies) + (1|IdentTree), 
               data = Data_stan_BCI,
               prior= prior_brms,
               iter = 10000 , warmup = 5000, thin = 5,
               chains = 2, cores=2)


save(brms_mod, file = here::here("outputs", "tropical_analysis", "brms_mod_Paracou.RData"))

```

```{r LoadBRMSParacou, include=FALSE}
load(here::here("outputs", "tropical_analysis", "brms_mod_Paracou.RData"))
```

```{r MCMCTraceParacou, fig.cap="Trace of the posterior estimates for the Paracou site", message=FALSE, warning=FALSE}
g <- brms::mcmc_plot(brms_mod, type="trace")
ggplot2::ggsave(filename="MCMC_trace_Paracou.png", path=here::here("outputs", "tropical_analysis", "figures"), device = "png", width = 7, height = 5)
knitr::include_graphics(here::here("outputs", "tropical_analysis", "figures", "MCMC_trace_Paracou.png"))

```

```{r MCMCDensityParacou, fig.cap = "Density of the posterior estimates for the Paracou site"}
g <- brms::mcmc_plot(brms_mod, type="dens")
ggplot2::ggsave(filename="MCMC_density_Paracou.png", path=here::here("outputs", "tropical_analysis", "figures"), device = "png", width = 7, height = 5)
knitr::include_graphics(here::here("outputs", "tropical_analysis", "figures", "MCMC_density_Paracou.png"))

```

```{r SummaryModelParacou}
Sum_paracou <- summary(brms_mod)
```

## Uppangala

```{r ModelUppangala, eval=FALSE, include=FALSE}
Uppangala_no_mean <-  coexIV::create_identspecies(Uppangala_no_mean)
Data_stan_Uppangala <- coexIV::prep_stan(Uppangala_no_mean)

print(nrow(Data_stan_Uppangala))

options("m.cores"=2)

### Priors

prior_brms <- c(brms::prior(normal(0, 1), class = "Intercept"),
                brms::prior(normal(0, 1), class = "b"),
                brms::prior(inv_gamma(10^-3, 10^-3), class = "sd"))

### Fit

brms_mod <- brms::brm(formula = logG ~ 1 + logD + logD2 + (1|IdentSpecies) + (1|IdentTree), 
               data = Data_stan_Uppangala,
               prior= prior_brms,
               iter = 10000 , warmup = 5000, thin = 5,
               chains = 2, cores=2)

save(brms_mod, file=here::here("outputs", "tropical_analysis", "brms_mod_Uppangala.RData"))

```

```{r LoadModelUppangala, include=FALSE}
load(here::here("outputs", "tropical_analysis", "brms_mod_Uppangala.RData"))
```

```{r MCMCTraceUppangala, fig.cap="Trace of the posterior estimates for the Uppangala site", message=FALSE, warning=FALSE}

g <- brms::mcmc_plot(brms_mod, type="trace")
ggplot2::ggsave(filename="MCMC_trace_Uppangala.png", path=here::here("outputs", "tropical_analysis", "figures"), device = "png", width = 7, height = 5)
knitr::include_graphics(here::here("outputs", "tropical_analysis", "figures", "MCMC_trace_Uppangala.png"))
```

```{r MCMCDensityUppangala, fig.cap = "Density of the posterior estimates for the Uppangala site"}
g <- brms::mcmc_plot(brms_mod, type="dens")
ggplot2::ggsave(filename="MCMC_density_Uppangala.png", path=here::here("outputs", "tropical_analysis", "figures"), device = "png", width = 7, height = 5)
knitr::include_graphics(here::here("outputs", "tropical_analysis", "figures", "MCMC_density_Uppangala.png"))
```

```{r SummaryModelUppangala}
Sum_uppangala <- summary(brms_mod)
```

## BCI

```{r ModelBCI, eval=FALSE, include=FALSE}
BCI_no_mean <-  coexIV::create_identspecies(BCI_no_mean)

Data_stan_BCI <- coexIV::prep_stan(BCI_no_mean)

print(nrow(Data_stan_BCI))

options("m.cores"=2)

### Priors

prior_brms <- c(brms::prior(normal(0, 1), class = "Intercept"),
                brms::prior(normal(0, 1), class = "b"),
                brms::prior(inv_gamma(10^-3, 10^-3), class = "sd"))

### Fit

brms_mod <- brms::brm(formula = logG ~ 1 + logD + (1|IdentSpecies) + (1|IdentTree), 
               data = Data_stan_BCI,
               prior= prior_brms,
               iter = 10000 , warmup = 5000, thin = 5,
               chains = 2, cores=2)


save(brms_mod, file = here::here("outputs", "tropical_analysis", "brms_mod_BCI.RData"))

```

```{r LoadModelBCI, include=FALSE}
load(here::here("outputs", "tropical_analysis", "brms_mod_BCI.RData"))
```

```{r MCMCTraceBCI, fig.cap="Trace of the posterior estimates for the BCI site", message=FALSE, warning=FALSE}

g <- brms::mcmc_plot(brms_mod, type="trace")
ggplot2::ggsave(filename="MCMC_trace_BCI.png", path=here::here("outputs", "tropical_analysis", "figures"), device = "png", width = 7, height = 5)
knitr::include_graphics(here::here("outputs", "tropical_analysis", "figures", "MCMC_trace_BCI.png"))

```

```{r MCMCDensityBCI, fig.cap = "Density of the posterior estimates for the BCI site"}
g <- brms::mcmc_plot(brms_mod, type="dens")
ggplot2::ggsave(filename="MCMC_density_BCI.png", path=here::here("outputs", "tropical_analysis", "figures"), device = "png", width = 7, height = 5)
knitr::include_graphics(here::here("outputs", "tropical_analysis", "figures", "MCMC_density_BCI.png"))
```

```{r SummaryModelBCI}
Sum_BCI <- summary(brms_mod)
```

```{r SummaryModels}
Res_mods <- 
  data.frame(
    Amount = rep(c("Estimate", "Estimation error"), 3),
    Intercept = c(
      format(as.numeric(Sum_paracou$fixed[1,1]), digits = 2, scientific = T),
      format(as.numeric(Sum_paracou$fixed[1,2]), digits = 2, scientific = T),
      format(as.numeric(Sum_uppangala$fixed[1,1]), digits = 2, scientific = T),
      format(as.numeric(Sum_uppangala$fixed[1,2]), digits = 2, scientific = T),
      format(as.numeric(Sum_BCI$fixed[1,1]), digits = 2, scientific = T),
      format(as.numeric(Sum_BCI$fixed[1,2]), digits = 2, scientific = T)
      ),
    Diameter = c(
      format(as.numeric(Sum_paracou$fixed[2,1]), digits = 2, scientific = T),
      format(as.numeric(Sum_paracou$fixed[2,2]), digits = 2, scientific = T),
      format(as.numeric(Sum_uppangala$fixed[2,1]), digits = 2, scientific = T),
      format(as.numeric(Sum_uppangala$fixed[2,2]), digits = 2, scientific = T),
      format(as.numeric(Sum_BCI$fixed[2,1]), digits = 2, scientific = T),
      format(as.numeric(Sum_BCI$fixed[2,2]), digits = 2, scientific = T)
      ),
    Vb = c(
      format(as.numeric(Sum_paracou$random$IdentSpecies[1]), digits = 2, scientific = T),
      format(as.numeric(Sum_paracou$random$IdentSpecies[2]), digits = 2, scientific = T),
      format(as.numeric(Sum_uppangala$random$IdentSpecies[1]), digits = 2, scientific = T),
      format(as.numeric(Sum_uppangala$random$IdentSpecies[2]), digits = 2, scientific = T),
      format(as.numeric(Sum_BCI$random$IdentSpecies[1]), digits = 2, scientific = T),
      format(as.numeric(Sum_BCI$random$IdentSpecies[2]), digits = 2, scientific = T)
      ),
    Vd = c(
      format(as.numeric(Sum_paracou$random$IdentTree[1]), digits = 2, scientific = T),
      format(as.numeric(Sum_paracou$random$IdentTree[2]), digits = 2, scientific = T),
      format(as.numeric(Sum_uppangala$random$IdentTree[1]), digits = 2, scientific = T),
      format(as.numeric(Sum_uppangala$random$IdentTree[2]), digits = 2, scientific = T),
      format(as.numeric(Sum_BCI$random$IdentTree[1]), digits = 2, scientific = T),
      format(as.numeric(Sum_BCI$random$IdentTree[2]), digits = 2, scientific = T)
      ),
    V=c(
      format(as.numeric(Sum_paracou$spec_pars[1]), digits = 2, scientific = T),
      format(as.numeric(Sum_paracou$spec_pars[2]), digits = 2, scientific = T),
      format(as.numeric(Sum_uppangala$spec_pars[1]), digits = 2, scientific = T),
      format(as.numeric(Sum_uppangala$spec_pars[2]), digits = 2, scientific = T),
      format(as.numeric(Sum_BCI$spec_pars[1]), digits = 2, scientific = T),
      format(as.numeric(Sum_BCI$spec_pars[2]), digits = 2, scientific = T)
      )
    )
kableExtra::kbl(
  Res_mods,
  booktabs = T,
  escape = F,
  col.names = c(" ", "Intercept ($\\beta_0$)", "Diameter ($\\beta_1$)", "Species variance ($V_b$)", "Individual variance ($V_d$)", "Residual variance ($V$)"),
  caption = "Variance partitioning of individual growth in three tropical forest sites. Shown are the mean posterior estimates and their estimated error from the growth model fitted for each site"
  ) %>%
  kableExtra::kable_styling(latex_options = c("striped", "hold_position", "scale_down"), full_width = F)%>%
  kableExtra::pack_rows("Paracou", start_row = 1, end_row = 2) %>% 
  kableExtra::pack_rows("Uppangala", start_row = 3, end_row = 4)%>%
  kableExtra::pack_rows("BCI", start_row = 5, end_row = 6)
```

```{r ComputeVarianceProportions}
Var_tot_Paracou <- as.numeric(Sum_paracou$random$IdentSpecies[1]) + as.numeric(Sum_paracou$random$IdentTree[1]) + as.numeric(Sum_paracou$spec_pars[1])

Var_tot_Uppangala <- as.numeric(Sum_uppangala$random$IdentSpecies[1]) + as.numeric(Sum_uppangala$random$IdentTree[1]) + as.numeric(Sum_uppangala$spec_pars[1])

Var_tot_BCI <- as.numeric(Sum_BCI$random$IdentSpecies[1]) + as.numeric(Sum_BCI$random$IdentTree[1]) + as.numeric(Sum_BCI$spec_pars[1])

Prop_var_Paracou <- data.frame(
  amount = c(round(as.numeric(Sum_paracou$random$IdentSpecies[1])/Var_tot_Paracou, digits = 2),
             round(as.numeric(Sum_paracou$random$IdentTree[1])/Var_tot_Paracou, digits = 2),
             round(as.numeric(Sum_paracou$spec_pars[1])/Var_tot_Paracou, digits = 2)),
  category = c("Species", "Individual", "Residual"))
Prop_var_Paracou$category <- factor(Prop_var_Paracou$category,
                                    levels = c("Species", "Individual", "Residual"))

Prop_var_Uppangala <- data.frame(
  amount=c(round(as.numeric(Sum_uppangala$random$IdentSpecies[1])/Var_tot_Uppangala, digits = 2),
           round(as.numeric(Sum_uppangala$random$IdentTree[1])/Var_tot_Uppangala, digits = 2),
           round(as.numeric(Sum_uppangala$spec_pars[1])/Var_tot_Uppangala, digits = 2)),
  category = c("Species", "Individual", "Residual"))
Prop_var_Uppangala$category <- factor(Prop_var_Uppangala$category,
                                    levels = c("Species", "Individual", "Residual"))

Prop_var_BCI <- data.frame(
  amount = c(round(as.numeric(Sum_BCI$random$IdentSpecies[1])/Var_tot_BCI, digits = 2),
             round(as.numeric(Sum_BCI$random$IdentTree[1])/Var_tot_BCI, digits = 2),
             round(as.numeric(Sum_BCI$spec_pars[1])/Var_tot_BCI, digits = 2)),
  category = c("Species", "Individual", "Residual"))
Prop_var_BCI$category <- factor(Prop_var_BCI$category,
                                    levels = c("Species", "Individual", "Residual"))

Prop_var_all_sites <- rbind(Prop_var_Paracou, Prop_var_Uppangala, Prop_var_BCI)
Prop_var_all_sites$Site <- factor(rep(c("Paracou", "Uppangala", "BCI"), each=nrow(Prop_var_Paracou)), levels=c("Paracou", "Uppangala", "BCI"))
Prop_var_all_sites$amount <- Prop_var_all_sites$amount*100

Plot_prop_var_Paracou <- ggplot2::ggplot(Prop_var_Paracou, ggplot2::aes(x="", y=amount, fill=category)) +
  ggplot2::geom_bar(stat="identity", width=1) +
  ggplot2::coord_polar("y", start=0) +
  ggplot2::geom_text(ggplot2::aes(label = paste0(amount, "%")), position = ggplot2::position_stack(vjust=0.5), size = 9) +
  ggplot2::labs(title = "Paracou", x = NULL, y = NULL, fill = "Variance components") +
  ggplot2::theme_classic() +
  ggplot2::theme(
    axis.line = ggplot2::element_blank(),
    axis.text = ggplot2::element_blank(),
    axis.ticks = ggplot2::element_blank(),
    legend.position = "none",
    legend.title = ggplot2::element_text(size = 20),
    legend.text = ggplot2::element_text(size = 20),
    text = ggplot2::element_text(size=20),
    plot.margin = ggplot2::margin(-1, 0, 2, 0, "cm"),
    plot.title = ggplot2::element_text(vjust = - 7)) +
  ggplot2::scale_fill_viridis_d()
  

Plot_prop_var_Uppangala <- ggplot2::ggplot(Prop_var_Uppangala, ggplot2::aes(x="", y=amount, fill=category)) +
  ggplot2::geom_bar(stat="identity", width=1) +
  ggplot2::coord_polar("y", start=0) +
  ggplot2::geom_text(ggplot2::aes(label = paste0(amount, "%")), position = ggplot2::position_stack(vjust=0.5), size = 9) +
  ggplot2::labs(title = "Uppangala", x = NULL, y = NULL, fill = "Variance components") +
  ggplot2::theme_classic() +
  ggplot2::theme(
    axis.line = ggplot2::element_blank(),
    axis.text = ggplot2::element_blank(),
    axis.ticks = ggplot2::element_blank(),
    legend.position = c(0.5, -0.05),
    legend.direction = "horizontal",
    legend.key.size = ggplot2::unit(0.3, 'cm'),
    legend.title = ggplot2::element_text(size = 20),
    legend.text = ggplot2::element_text(size = 20),
    text = ggplot2::element_text(size=20),
    plot.margin = ggplot2::margin(-1, 0, 2, 0, "cm"),
    plot.title = ggplot2::element_text(vjust = - 7)) +
  ggplot2::scale_fill_viridis_d(
    guide = ggplot2::guide_legend(
      title.position = "top",
      label.position="bottom")
  )

Plot_prop_var_BCI <- ggplot2::ggplot(Prop_var_BCI, ggplot2::aes(x="", y=amount, fill=category)) +
  ggplot2::geom_bar(stat="identity", width=1) +
  ggplot2::coord_polar("y", start=0) +
  ggplot2::geom_text(ggplot2::aes(label = paste0(amount, "%")), position = ggplot2::position_stack(vjust=0.5), size = 9) +
  ggplot2::labs(title = "BCI", x = NULL, y = NULL, fill = "Variance components") +
  ggplot2::theme_classic() +
  ggplot2::theme(
    axis.line = ggplot2::element_blank(),
    axis.text = ggplot2::element_blank(),
    axis.ticks = ggplot2::element_blank(),
    legend.position = "none",
    legend.title = ggplot2::element_text(size = 20),
    legend.text = ggplot2::element_text(size = 20),
    text = ggplot2::element_text(size=20),
    plot.margin = ggplot2::margin(-1, 0, 2, 0, "cm"),
    plot.title = ggplot2::element_text(vjust = - 7)) +
  ggplot2::scale_fill_viridis_d()

ggplot2::ggsave(filename = "Variance_partition_Paracou.png", plot = Plot_prop_var_Paracou, path=here::here("outputs", "tropical_analysis", "figures"), device = "png", width = 5, height = 5)


ggplot2::ggsave(filename = "Variance_partition_Uppangala.png", plot = Plot_prop_var_Uppangala, path=here::here("outputs", "tropical_analysis", "figures"), device = "png", width = 5, height = 5)


ggplot2::ggsave(filename = "Variance_partition_BCI.png", plot = Plot_prop_var_BCI, path=here::here("outputs", "tropical_analysis", "figures"), device = "png", width = 5, height = 5)

Plot_prop_var_all <- ggplot2::ggplot(data = Prop_var_all_sites, ggplot2::aes(x=amount, y=Site, fill=category))+
  ggplot2::geom_col(width=0.3)+ 
  ggplot2::geom_text(ggplot2::aes(label = amount), position = ggplot2::position_stack(vjust=0.5), vjust=4, size=5)+
  ggplot2::labs(title = NULL, x = NULL, y = NULL, fill = "Variance components (%)") +
  ggplot2::scale_fill_viridis_d()+
  ggplot2::theme_classic()+
  ggplot2::theme(axis.line = ggplot2::element_blank(),
          axis.text.x = ggplot2::element_blank(),
          axis.ticks = ggplot2::element_blank(),
          legend.position = "bottom",
          text = ggplot2::element_text(size = 20))+
  ggplot2::scale_x_reverse()+
  ggplot2::scale_y_discrete(limits = rev(levels(Prop_var_all_sites$Site)))

ggplot2::ggsave(filename = "Variance_partition.png", plot = Plot_prop_var_all, path=here::here("outputs", "tropical_analysis", "figures"), device = "png", width = 15, height = 6)


```

```{r PlotsVarianceProportion, eval=FALSE, fig.cap="Variance partitioning of individual growth in three tropical forest sites (see Table above)", fig.show="hold", include=FALSE, out.width="33%"}

knitr::include_graphics(
  c(
    here::here("outputs", "tropical_analysis", "figures", "Variance_partition_Paracou.png"),
    here::here("outputs", "tropical_analysis", "figures", "Variance_partition_Uppangala.png"),
    here::here("outputs", "tropical_analysis", "figures", "Variance_partition_BCI.png")
    )
  )

```

```{r PlotVarianceProportionAllSites, fig.cap="Variance partitioning of individual growth in three tropical forest sites (see Table above)."}

knitr::include_graphics(here::here("outputs", "tropical_analysis", "figures", "Variance_partition.png")) 

```

Overall, a large part of variability in tree growth was imputable to individual effects in the three sites, even after accounting for the effect of diameter on tree growth, showing a high intraspecific variability in growth in these tropical forests (Figure \@ref(fig:PlotVarianceProportionAllSites)).

# Moran's I analysis

In order to test if individual tree growth was spatially autocorrelated within each site, we performed a Moran’s I test on individual mean growth for each species with more than 5 individuals. For very abundant species (with more than 3,000 individuals), we sampled 3,000 individuals with a uniform probability. Moran’s I test function was re-written from the ape package’s Moran.I function with a one-tailed test [@paradis_ape_2019] in order to be able to select the pairs of neighbours that are less than 100-m apart and thus assess local spatial autocorrelation.


```{r MoransTests, eval=FALSE, include=FALSE}
Moran_I_Paracou <- coexIV::moran_analysis(Data_Paracou)
Moran_I_Uppangala <- coexIV::moran_analysis(Data_Uppangala)
Data_BCI$Plot <- rep(1, nrow(Data_BCI))
Data_BCI$Sp <- as.factor(Data_BCI$Sp)
Moran_I_BCI <- coexIV::moran_analysis(Data_BCI)
save(Moran_I_Paracou, file=here::here("outputs", "tropical_analysis", "Moran_I_Paracou.RData"))
save(Moran_I_Uppangala, file=here::here("outputs", "tropical_analysis", "Moran_I_Uppangala.RData"))
save(Moran_I_BCI, file=here::here("outputs", "tropical_analysis", "Moran_I_BCI.RData"))
```

```{r LoadMoran, include=FALSE}
load(file=here::here("outputs", "tropical_analysis", "Moran_I_Paracou.RData"))
load(file=here::here("outputs", "tropical_analysis", "Moran_I_Uppangala.RData"))
load(file=here::here("outputs", "tropical_analysis", "Moran_I_BCI.RData"))
```

```{r CountMoranInfOne, eval=FALSE, include=FALSE}
#Check for significant negative spatial autocorrelation
which(Moran_I_Paracou$Moran.I<0&Moran_I_Paracou$signif==1)
which(Moran_I_Uppangala$Moran.I<0&Moran_I_Uppangala$signif==1)
which(Moran_I_BCI$Moran.I<0&Moran_I_BCI$signif==1)
```


We then computed the proportion of species with a significantly and  positively spatial autocorrelated growth (with a 0.05 alpha risk) and the proportion of species with non significant spatial autocorrelation, as well as the corresponding proportion of individuals. The proportions are computed relative to the species on which the test was performed.

```{r MoransResults}
Results_moran <- coexIV::results_moran(data1=Moran_I_Paracou, data2=Moran_I_Uppangala, data3 = Moran_I_BCI)

save(Results_moran, file=here::here("outputs", "tropical_analysis", "Results_moran.RData"))

kableExtra::kbl(Results_moran, booktabs = T, caption = "Spatial autocorrelation of the growth of conspecific individuals in three tropical forest sites. Shown are the proportion of species, and of corresponding individuals, in \\%, for which individual growth was significantly positively spatially autocorrelated. The spatial autocorrelation of individual growth was tested using Moran’s I index.")%>%
  kableExtra::kable_styling(latex_options = c("striped", "hold_position"),
                full_width = FALSE) %>%
  kableExtra::pack_rows("Paracou", start_row = 1, end_row = 2) %>% 
  kableExtra::pack_rows("Uppangala", start_row = 3, end_row = 4)%>%
  kableExtra::pack_rows("BCI", start_row = 5, end_row = 6)

```

`r round(as.numeric(Results_moran[1,]$Significant))`%, `r round(as.numeric(Results_moran[3,]$Significant))`%, and `r round(as.numeric(Results_moran[5,]$Significant))`% of the species showed a positive and significant spatial autocorrelation in tree growth, in Paracou, Uppangala, and BCI respectively. (Table \@ref(tab:MoransResults)).

```{r ModelsSignificanceMoran, message=FALSE, warning=FALSE, include=FALSE}
## Test to see if the number of individuals explains the significance ##
model <- glm(factor(signif) ~ nb_ind,family=binomial(link='logit'),data=na.omit(Moran_I_Paracou))
summary(model)
# R^2 equivalent for glm:
#with(summary(model), 1 - deviance/null.deviance)
model <- glm(factor(signif) ~ nb_ind,family=binomial(link='logit'),data=na.omit(Moran_I_Uppangala))
summary(model)
#with(summary(model), 1 - deviance/null.deviance)
model <- glm(factor(signif) ~ nb_ind,family=binomial(link='logit'),data=na.omit(Moran_I_BCI))
summary(model)
#with(summary(model), 1 - deviance/null.deviance)
```


Although the three forest sites are located in very different areas across the tropics, with contrasting biogeographical history, climate, regime of perturbations and topography, they all showed a substantial spatial autocorrelation of tree growth intraspecific variability, which supports the generality of our results.The magnitude of spatial autocorrelation varied across the three sites however, with Paracou presenting the biggest proportion and Uppangala the lowest, which can be related to each site specificities. The plots of the Paracou site were subjected to disturbance treatments that created numerous large gaps [@molino_tree_2001]. This resulted in a high heterogeneity and spatial structuration of the environment. When restricting our analysis to undisturbed control plots (see \@ref(undisturbed) below), the proportion of detected spatial autocorrelation in conspecific growth drops from `r round(as.numeric(Results_moran[2,]$Significant))`% to `r round(as.numeric(Results_moran[6,]$Significant))`% individuals, supporting the hypothesis that the more important spatial autocorrelation in Paracou is due to the stronger spatial structuration of the micro-environment associated with disturbance treatments. Conversely, the disturbance regime in BCI is known to produce frequent small gaps [@hubbell_light-gap_1999], while the mature forest in Uppangala has been reported as barely disturbed [@pelissier_tree_2011]. We acknowledge that the hilly topography of Uppangala could make our estimates of distances among individuals based on pairs of tree coordinates provided by field inventory less accurate than in the other two flatter sites.


# Is variance within conspecifics inferior to variance within heterospecifics ?

In order to test if the performance of conspecifics was locally more similar than that of heterospecifics in the three tropical forests, for each species with more than five individuals and more than five heterospecific neighbours within 100-m radii around these individuals , we computed the semivariances of growth of individuals that are less than 100-m apart, considering conspecifics only on the one hand, and heterospecifics on the other hand. In the first case, semivariance was estimated as the mean of the squared difference in individual mean growth for all pairs of conspecific individuals. In the second case, semivariance was estimated as the mean of the squared difference in individual mean growth for all pairs of individuals with an individual of the focal species and one of another species.  For each species, we compared the semivariances obtained with conspecifics only to the ones obtained with heterospecifics using a Mann-Whitney test. 

For each site, the proportion of species with a significantly higher or lower semivariance than the one estimated with heterospecifics or for which the difference was not significant, and the corresponding proportion of individuals were then computed.


```{r ComputeDistances, eval=FALSE, include=FALSE}
nfiles=7

for (plot in sort(unique(Data_Paracou$Plot))) {
  distlist(cbind(Data_Paracou[which(Data_Paracou$Plot==plot),]$X, Data_Paracou[which(Data_Paracou$Plot==plot),]$Y), plot, "Paracou")
  for (file in 0:(nfiles-1)){
    file.rename(here::here(glue::glue("file{file}_{plot}_P.txt")), here::here("outputs", "tropical_analysis", "Dists_Paracou", glue::glue("file{file}_{plot}_P.txt")))
  }
}

for (plot in sort(unique(Data_Uppangala$Plot))){
  distlist(cbind(Data_Uppangala[which(Data_Uppangala$Plot==plot),]$X, Data_Uppangala[which(Data_Uppangala$Plot==plot),]$Y), plot, "Uppangala")
  for (file in 0:(nfiles-1)){
    file.rename(here::here(glue::glue("file{file}_{plot}_U.txt")), here::here("outputs", "tropical_analysis", "Dists_Uppangala", glue::glue("file{file}_{plot}_U.txt")))
  }
}

distlist(cbind(Data_BCI$X, Data_BCI$Y), 1, "BCI")

for (file in 0:(nfiles-1)){
  file.rename(here::here(glue::glue("file{file}_1_B.txt")), here::here("outputs", "tropical_analysis", "Dists_BCI", glue::glue("file{k}_1_B.txt")))
}

```

```{r VarianceComparison, eval=FALSE, include=FALSE}

Var_comp_Paracou <- coexIV::variance_comp(data=Data_Paracou, nfiles=nfiles, "Paracou")
save(Var_comp_Paracou, file=here::here("outputs", "tropical_analysis", "Var_comp_Paracou.RData"))

Var_comp_Uppangala <- coexIV::variance_comp(data=Data_Uppangala, nfiles=nfiles, "Uppangala")
save(Var_comp_Uppangala, file=here::here("outputs", "tropical_analysis", "Var_comp_Uppangala.RData"))

Var_comp_BCI <- coexIV::variance_comp(data=Data_BCI, nfiles=nfiles, "BCI")
save(Var_comp_BCI, file=here::here("outputs", "tropical_analysis", "Var_comp_BCI.RData"))
```

```{r LoadVarianceComparison, include=FALSE}
load(here::here("outputs", "tropical_analysis", "Var_comp_Paracou.RData"))
load(here::here("outputs", "tropical_analysis", "Var_comp_Uppangala.RData"))
load(here::here("outputs", "tropical_analysis", "Var_comp_BCI.RData"))
```


```{r ResultsVarianceComparison}
Results_var_comp <- coexIV::results_var_comp(data1=Var_comp_Paracou, data2=Var_comp_Uppangala, data3=Var_comp_BCI, site1="Paracou", site2="Uppangala", site3="BCI")
save(Results_var_comp, file=here::here("outputs", "tropical_analysis", "Results_var_comp.RData"))

Results_var_comp %>%
  dplyr::mutate_all(kableExtra::linebreak) %>%
  kableExtra::kbl(booktabs = TRUE, caption="Comparison of local intra- and interspecific variability in individual growth for three tropical forest sites. The variability was estimated with the semivariance and the comparison was performed with a Mann-Whitney’s test. The semivariances were computed for all species with > 5 individuals and > 5 heterospecific neighbours within 100 m in the same plot, and considering pairs of individuals that were less than 100 m apart and in the same plot. Shown are the proportion of species, and of corresponding individuals, for which (i) intraspecific variability was significantly lower than interspecific variability, (ii) intraspecific variability was significantly higher than interspecific variability, or (iii) the difference between inter- and intraspecific variabilities was not significant.") %>%
  kableExtra::kable_styling(latex_options = c("striped", "hold_position", "scale_down"),
                full_width = F) %>%
  kableExtra::pack_rows("Paracou", start_row = 1, end_row = 2) %>% 
  kableExtra::pack_rows("Uppangala", start_row = 3, end_row = 4)%>%
  kableExtra::pack_rows("BCI", start_row = 5, end_row = 6)%>%
  kableExtra::column_spec(2:4, width="3cm")

```

```{r ResultsVarianceComparisonSample}
Results_var_comp_sample <- coexIV::results_var_comp_sample(data1=Var_comp_Paracou, data2=Var_comp_Uppangala, data3=Var_comp_BCI, site1="Paracou", site2="Uppangala", site3="BCI")
save(Results_var_comp_sample, file=here::here("outputs", "tropical_analysis", "Results_var_comp_sample.RData"))

Results_var_comp_sample %>%
  dplyr::mutate_all(kableExtra::linebreak) %>%
  kableExtra::kbl(booktabs = TRUE, caption="Comparison of local intra- and interspecific variability in individual growth for three tropical forest sites, when controlling for species abundance. See Table 3. Semivariances with heterospecifics were here computed by sampling a maximum of 10 individuals per species.") %>%
  kableExtra::kable_styling(latex_options = c("striped", "hold_position", "scale_down"),
                full_width = F) %>%
  kableExtra::pack_rows("Paracou", start_row = 1, end_row = 2) %>% 
  kableExtra::pack_rows("Uppangala", start_row = 3, end_row = 4)%>%
  kableExtra::pack_rows("BCI", start_row = 5, end_row = 6)%>%
  kableExtra::column_spec(2:4, width="3cm")

```


In all three tropical forest sites however, growth semivariance was locally significantly higher among heterospecifics than among conspecifics in a large proportion of the tested cases (`r round(as.numeric(Results_var_comp[1,2]))`%, `r round(as.numeric(Results_var_comp[3,2]))`% and `r round(as.numeric(Results_var_comp[5,2]))`% of the species, and `r round(as.numeric(Results_var_comp[2,2]))`%, `r round(as.numeric(Results_var_comp[4,2]))`% and `r round(as.numeric(Results_var_comp[6,2]))`% of the individuals in Paracou, Uppangala and BCI respectively; Table \@ref(tab:ResultsVarianceComparison)).

Note that, to control for a potential effect of species abundance on the values of semivariances with heterospecifics, we replicated the analysis by computing the semivariances with heterospecifics by sampling a maximum of ten individuals per species. The results were qualitatively unchanged (Table \@ref(tab:ResultsVarianceComparisonSample)).


# Other tests and verifications

## Undisturbed plots in the Paracou site {#undisturbed}

One of our main hypotheses was that since many environmental variables are spatially structured and that tree growth is largely influenced by environmental variables, tree growth should be spatially structured. Our analysis using Moran’s I test showed that tree growth was indeed spatially structured at our study sites. The Paracou dataset offers the opportunity to test this hypothesis further. Indeed, some plots were disturbed in the early eighties, creating artificial gaps, whereas others were not disturbed. As the creation of gaps results in a strong spatial structure of the light available under the canopy, we hypothesized that growth should be less structured in plots that were not disturbed.

```{r ParacouUndisturbed, include=FALSE}
Data_Paracou_undisturbed <- Data_Paracou[which(Data_Paracou$Plot%in%c(1, 6, 11)),]
```

```{r MoranParacouUndisturbed, eval=FALSE, include=FALSE}
Moran_I_Paracou_undisturbed <- coexIV::moran_analysis(Data_Paracou_undisturbed)
save(Moran_I_Paracou_undisturbed, file=here::here("outputs", "tropical_analysis", "Moran_I_Paracou_undisturbed.RData"))
```

```{r ResultsMoranParacouUndisturbed}
load(file=here::here("outputs", "tropical_analysis", "Moran_I_Paracou_undisturbed.RData"))

#Table of results
Results_moran_undisturbed <- coexIV::results_moran_undisturbed(data=Moran_I_Paracou_undisturbed)

save(Results_moran_undisturbed, file=here::here("outputs", "tropical_analysis", "Results_moran_undisturbed.RData"))

kableExtra::kbl(Results_moran_undisturbed, booktabs = T, caption = "Spatial autocorrelation of the growth of conspecific individuals in the undisturbed plots of the Paracou site. Shown are the proportion of species, and of corresponding individuals, in \\%, for which individual growth was significantly spatially autocorrelated, or not significantly spatially autocorrelated. The spatial autocorrelation of individual growth was tested using Moran’s I index.")%>%
  kableExtra::kable_styling(latex_options = c("striped", "hold_position", full_width = FALSE))
```

Considering the undisturbed plots only, the proportion of individuals of species with a significant Moran’s I test was `r round(as.numeric(Results_moran_undisturbed[2,2]))`%, much lower than when including the disturbed plots (`r round(as.numeric(Results_moran[2,2]))`%, see Table \@ref(tab:MoransResults); Table \@ref(tab:ResultsMoranParacouUndisturbed)). This corroborates our hypothesis that  the openness of the canopy triggered important spatial structure in disturbed plots due to light gaps, and as in these gaps, trees tend to grow faster, the spatial structure of growth is stronger.

## Smaller stems in the BCI site

In order to be able to compare all three datasets together, we removed all stems that had a DBH inferior to 10 cm in the BCI inventories, which include all stems with DBH $\ge$ 1 cm.  We replicated our analysis on the spatial autocorrelation of tree growth in the complete dataset and found that the spatial structure in individual growth was even more significant.

# Code implementation

The whole analysis was conducted using the R language [@R] in the Rstudio environment [@RStudio]. The tables were made with the kableExtra package [@kableExtra], the figures with the package ggplot2 [@wickham_ggplot2_2009], and the code uses other packages of the Tidyverse [@wickham_welcome_2019] (tidyr [@tidyr], dplyr [@dplyr], readr [@readr], lubridate [@grolemund_dates_2011], glue [@glue], magrittr [@magrittr]) and other R packages (here [@here], sp [@sp, @bivand_applied_2013]). Some functions were implemented in C++ thanks to the R packages Rcpp [@eddelbuettel_rcpp_2011 ; @eddelbuettel_seamless_2013 ; @eddelbuettel_extending_2018] and RcppArmadillo [@eddelbuettel_rcpparmadillo_2014]. The pdf and html documents were produced thanks to the R packages rmarkdown [@Allaire2020-sr, @xie_r_2019, @xie_r_2020], knitr [@knitr, @xie_dynamic_2015, @stodden_knitr_2014] and bookdown [@xie_bookdown_2017].


# References
